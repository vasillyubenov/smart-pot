var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(a,c,b){a instanceof String&&(a=String(a));for(var e=a.length,d=0;d<e;d++){var f=a[d];if(c.call(b,f,d,a))return{i:d,v:f}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,c,b){a!=Array.prototype&&a!=Object.prototype&&(a[c]=b.value)};$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(a,c,b,e){if(c){b=$jscomp.global;a=a.split(".");for(e=0;e<a.length-1;e++){var d=a[e];d in b||(b[d]={});b=b[d]}a=a[a.length-1];e=b[a];c=c(e);c!=e&&null!=c&&$jscomp.defineProperty(b,a,{configurable:!0,writable:!0,value:c})}};$jscomp.polyfill("Array.prototype.findIndex",function(a){return a?a:function(a,b){return $jscomp.findInternal(this,a,b).i}},"es6","es3");var C={DNSIP:"192.168.4.1",APNAME:"ESP32"},wifi=require("Wifi");
function WifiManager(a){this.options=a=a||{};this.minimumQuality=a.minimumQuality||-1;this.wifiScanInterval=a.wifiScanInterval||3E4;this.apName=a.apName||C.APNAME;this.title=a.title||C.APNAME;this.params=a.params||[];this.paramscallback=a.paramscallback;this.connectedcallback=a.connectedcallback;this.log=a.log||console.log;this.restart=a.restart||function(){require("ESP32").reboot()};this.wifiitems=""}
function wifiScan(a){a.log("scan wifi...");wifi.scan(function(c){c=c.sort(function(a,b){return b.rssi-a.rssi});c=c.filter(function(a,b,c){return b===c.findIndex(function(b){return b.ssid===a.ssid})});var b=0,e="";c.forEach(function(c){var d=getRSSIasQuality(c.rssi);if(-1==a.minimumQuality||a.minimumQuality<d)b++,e+=HTTP_ITEM.replace("{v}",c.ssid).replace("{r}",d).replace("{i}","open"==c.authmode?"":"l")});0===b&&(e="No networks found.");wifiitems="<br/>"+e;a.log("wifi scan done. found "+b+" networks.");
a.wifiscantimer=setTimeout(function(){wifiScan(a)},a.wifiScanInterval)})}function getRSSIasQuality(a){return-100>=a?0:-50<=a?100:2*(a+100)}
WifiManager.prototype.start=function(a){if("connecting"==wifi.getStatus().station)return setTimeout(function(){a.start(a)},500),!1;"0.0.0.0"===wifi.getIP().ip?(a.log("No wifi connection. Starting setup. Connect to ap "+a.apName+" for setup."),wifi.setConfig({powersave:"none"}),wifi.startAP(a.apName,{},function(c){c&&(a.log(c),a.restart(c));a.log("AP started");a.startHttpServer();a.startDNSServer();setTimeout(function(){wifiScan(a)},2E3)})):(a.log("wifi connected. IP: "+wifi.getIP().ip),wifi.stopAP(),
a.scanwifitimer&&clearTimeout(a.scanwifitimer),a.connectedcallback&&a.connectedcallback())};WifiManager.prototype.params=function(){return this.params};
var HTTP_HEAD="<!DOCTYPE html><html lang='en'><head><meta charset='UTF-8' name='viewport' content='width=device-width, initial-scale=1, user-scalable=no' /><style>.c{text-align: center;}div, input {padding: 5px;        font-size: 1em;      }      input {        width: 95%;      }      body {        text-align: center;        font-family: verdana;      }      button {        border: 0;        border-radius: 0.3rem;        background-color: #1fa3ec;        color: #fff;        line-height: 2.4rem;        font-size: 1.2rem;        width: 100%;      }      .q {        float: right;        width: 64px;        text-align: right;      }      .l {        background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAALVBMVEX///8EBwfBwsLw8PAzNjaCg4NTVVUjJiZDRUUUFxdiZGSho6OSk5Pg4eFydHTCjaf3AAAAZElEQVQ4je2NSw7AIAhEBamKn97/uMXEGBvozkWb9C2Zx4xzWykBhFAeYp9gkLyZE0zIMno9n4g19hmdY39scwqVkOXaxph0ZCXQcqxSpgQpONa59wkRDOL93eAXvimwlbPbwwVAegLS1HGfZAAAAABJRU5ErkJggg==') no-repeat left center;        background-size: 1em;      }    </style>    <script>      function c(l) {        document.getElementById('s').value = l.innerText || l.textContent;        document.getElementById('p').focus();      }    \x3c/script>  </head>  <body>    <div style='text-align:left;display:inline-block;min-width:260px;'>",HTTP_ITEM=
"<div><a href='#p' onclick='c(this)'>{v}</a>&nbsp;<span class='q {i}'>{r}%</span></div>",HTTP_FORM_START="<form method='get' action='/s'><input id='s' name='s' length=32 placeholder='SSID'><br/><input id='p' name='p' length=64 type='password' placeholder='password'><br/><input id='n' name='n' length=32 placeholder='Device name' value='{n}'><br/>",HTTP_FORM_PARAM="<input id='{i}' name='{n}' maxlength={l} placeholder='{p}' value='{v}' {c}><br/>",HTTP_FORM_END="<br/><button type='submit'>Save and connect</button></form>",
HTTP_SCAN_LINK="<br/><div class='c'><a href='/'>Scan for networks</a></div>",HTTP_SAVED="<div>Credentials Saved!<br/>Trying to connect ESP to network...<br/>If it fails reconnect to AP to try again.</div>",HTTP_END="</div></body></html>";
function onPageRequest(a,c,b){console.log("parsed urs is"+a.url);var e=url.parse(a.url,!0);b.params||(b.params=[]);if("/"===e.pathname||""===e.pathname){var d=HTTP_HEAD;d+="<h1>"+b.title+"</h1>";d+="<h3>Setup Wifi</h3>";d+=HTTP_FORM_START.replace("{n}",b.apName);b.params.forEach(function(a){a=a.id?HTTP_FORM_PARAM.replace("{i}",a.id).replace("{n}",a.id).replace("{p}",a.placeholder||"").replace("{l}",a.valueLength||"").replace("{v}",a.value||"").replace("{c}",a.customHTML||""):a.customHTML;
d+=a});d+=wifiitems;d+=HTTP_FORM_END;d+=HTTP_SCAN_LINK;d+=HTTP_END;c.writeHead(200,{"Content-Length":d.length,"Content-Type":"text/html"});c.end(d)}else"/s"===e.pathname?(b.params.forEach(function(a){a.value=e.query[a.id]}),d=HTTP_HEAD,d+=HTTP_SAVED,d+=HTTP_END,c.writeHead(200,{"Content-Length":d.length,"Content-Type":"text/html"}),c.end(d),wifi.setHostname(e.query.n||b.apName),wifi.connect(e.query.s,{password:e.query.p},function(a){a?b.log("error connecting to wifi: "+a):(b.log("wifi connected"),
setTimeout(wifi.save,200),wifi.stopAP(function(){b.connectedcallback?b.connectedcallback():setTimeout(b.restart,1E3)}))}),b.paramscallback&&b.paramscallback(b.params)):"/r"===e.pathname?(d=HTTP_HEAD,d+="Module will reset in a few seconds.",d+=HTTP_END,c.writeHead(200,{"Content-Length":d.length,"Content-Type":"text/html"}),c.end(d),setTimeout(b.restart,200)):(c.writeHead(302,{Location:"http://"+b.apName}),c.end(""))}
function dnsQname(a){for(var c=12,b="";"\x00"!==a[c];)b+=a[c],c++;return b+"\x00"}function dnsResponse(a,c){return a[0]+a[1]+"\u0081\u0080\x00\u0001\x00\u0001\x00\x00\x00\x00"+dnsQname(a)+"\x00\u0001\x00\u0001\u00c0\f\x00\u0001\x00\u0001\x00\x00\x00\u00f9\x00\u0004"+c}
WifiManager.prototype.startDNSServer=function(){var a=this;this.dns=require("dgram").createSocket("udp4");var c=C.DNSIP.split(".").map(function(a){return String.fromCharCode(parseInt(a,10))}).join("");this.dns.on("error",function(b){a.log("error starting dns server: "+b);a.restart()});this.dns.on("message",function(b,e){"\u0001"===b[b.length-3]&&a.dns.send(dnsResponse(b,c),e.port,e.address)});this.dns.bind(53)};
WifiManager.prototype.startHttpServer=function(){console.log("Starting server!");this.server=require("http").createServer(function(a,c){onPageRequest(a,c,this)});this.server.listen(80)};start=function(a,c){c=c||{};c.connectedcallback=a;var b=new WifiManager(c);setTimeout(function(){b.start(b);1E3})};start(function(){return console.log("connected")},{});